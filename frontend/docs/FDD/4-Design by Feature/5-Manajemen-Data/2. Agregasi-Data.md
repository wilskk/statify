# Desain Fitur: Agregasi Data

Dokumen ini berisi paket desain (Design Package) untuk Feature Set `Agregasi Data`.

---

## 2. Design Package

### 2.1. Diagram Urutan (Sequence Diagrams)

*Diagram ini menunjukkan alur di mana pengguna mengonfigurasi agregasi, yang kemudian diproses oleh worker.*

### **Sequence Diagram: Aggregate Data**

Dokumentasi ini berisi diagram sekuens yang merinci alur kerja fitur "Aggregate Data", mulai dari konfigurasi hingga pemrosesan akhir.

---

### 1. Alur Proses Konfigurasi Variabel Agregat

Diagram ini menunjukkan bagaimana pengguna mengonfigurasi fungsi, nama, dan label untuk variabel agregat baru melalui dialog-dialog yang tersedia.

```mermaid
sequenceDiagram
    title: Alur Proses Konfigurasi Variabel Agregat
    actor User

    box "Frontend Components"
        participant View as "VariablesTab<br>.../Aggregate/VariablesTab.tsx"
        participant Hook as "useAggregateData<br>.../hooks/useAggregateData.ts"
        participant FuncDlg as "FunctionDialog<br>.../dialogs/FunctionDialog.tsx"
        participant NameDlg as "NameLabelDialog<br>.../dialogs/NameLabelDialog.tsx"
    end

    User->>+View: Pilih variabel agregat & klik "Function..."
    View->>+Hook: handleFunctionClick()
    Hook->>Hook: setCurrentEditingVariable()
    Hook-->>+FuncDlg: Buka dialog dengan data var
    deactivate Hook

    User->>FuncDlg: Pilih fungsi & klik "Continue"
    FuncDlg->>+Hook: applyFunction()
    Hook->>Hook: Memperbarui state `aggregatedVariables`
    deactivate Hook
    FuncDlg-->>-View: Tutup dialog & update tampilan
    deactivate FuncDlg

    User->>+View: Pilih variabel agregat & klik "Name & Label..."
    View->>+Hook: handleNameLabelClick()
    Hook->>Hook: setCurrentEditingVariable()
    Hook-->>+NameDlg: Buka dialog dengan data var
    deactivate Hook

    User->>NameDlg: Ubah nama/label & klik "Continue"
    NameDlg->>+Hook: applyNameLabel()
    Hook->>Hook: Memperbarui state `aggregatedVariables`
    deactivate Hook
    NameDlg-->>-View: Tutup dialog & update tampilan
    deactivate NameDlg
```

---

### 2. Alur Proses Agregasi Data

Diagram ini merinci proses yang terjadi setelah pengguna mengklik "OK". Ini mencakup pengelompokan data, penghitungan nilai agregat, pembuatan variabel baru, dan pembaruan data di grid.

```mermaid
sequenceDiagram
    title: Alur Proses Agregasi Data
    actor User

    box "Frontend Components"
        participant View as "AggregateModal<br>.../Aggregate/index.tsx"
        participant Hook as "useAggregateData<br>.../hooks/useAggregateData.ts"
        participant Utils as "Utils.ts<br>.../Aggregate/Utils.ts"
    end

    box "Zustand Stores"
        participant VarStore as "useVariableStore"
        participant DataStore as "useDataStore"
        participant ModalStore as "useModalStore"
    end

    User->>+View: Klik tombol "OK"
    View->>+Hook: handleConfirm(closeModal)
    Hook->>+ModalStore: setStatisticProgress(true)
    deactivate ModalStore
    
    Hook->>Hook: Mengelompokkan data dari DataStore
    
    loop untuk setiap aggregatedVariable
        Hook->>+Utils: calculateAggregateValue(func, values, opts)
        Utils-->>-Hook: aggregatedValue
        
        Hook->>+VarStore: addVariable(newAggregatedVariable)
        deactivate VarStore
    end

    alt jika "Number of cases" dicentang
        Hook->>+VarStore: addVariable(nCasesVariable)
        deactivate VarStore
    end

    Hook->>+DataStore: updateCells(bulkUpdates)
    deactivate DataStore
    
    Hook->>+ModalStore: setStatisticProgress(false)
    deactivate ModalStore
    Hook-->>-View: closeModal()
    deactivate Hook
```

### 2.2. Penyempurnaan Model Objek (Object Model Refinements)

*Perubahan pada model objek (kelas, atribut, metode baru) yang ditemukan selama desain.*

- **Komponen Modal Bertab:**
  - `Aggregate/index.tsx`: Komponen induk yang mengelola tab.
  - `VariablesTab.tsx`: UI untuk memilih variabel pemisah dan agregat.
  - `OptionsTab.tsx`: UI untuk mengatur bagaimana output akan disimpan.
  - `dialogs/FunctionDialog.tsx`, `dialogs/NameLabelDialog.tsx`: Dialog kecil untuk mengonfigurasi setiap variabel agregat.
- **Hook Logika:**
  - `useAggregateData.ts`: Mengumpulkan semua konfigurasi dari state UI, memanggil web worker, dan menangani hasilnya.
- **Web Worker:**
  - `aggregate.worker.js`: Menerima data lengkap dan konfigurasi, melakukan loop melalui data untuk membuat grup berdasarkan variabel pemisah, menghitung fungsi agregat untuk setiap grup, dan mengembalikan dataset yang baru.

### 2.3. Catatan Alternatif Desain (Design Alternatives)

*Diskusi dan keputusan mengenai pilihan desain yang signifikan.*

- **Alternatif 1:** UI satu halaman yang panjang untuk semua opsi.
  - **Kelebihan:** Tidak ada kompleksitas manajemen tab.
  - **Kekurangan:** UI akan terasa sangat padat dan menakutkan bagi pengguna.
- **Keputusan:** Menggunakan antarmuka bertab. Ini memisahkan pemilihan variabel dari opsi output, menciptakan alur kerja yang lebih bersih dan lebih mudah dikelola bagi pengguna. 