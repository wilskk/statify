// Generated by Grafana k6 Studio (1.6.0) on 2025-08-15T04:50:00.000Z
// Modified for Statify Crosstabs testing with smoke/baseline/burst/soak configurations

import { browser } from "k6/browser";
import { check, sleep } from "k6";
import { Trend, Gauge } from "k6/metrics";

const BASE_URL = __ENV.BASE_URL || 'https://statify-dev.student.stis.ac.id';

// Suppress non-error logs (hide info/warn/segment logs)
try {
  if (typeof console === 'object') {
    console.info = () => {};
    console.warn = () => {};
    console.log = () => {};
  }
} catch (_) {}

export const options = (() => {
  const scenario = (__ENV.SCENARIO || 'smoke').toLowerCase();
  const commonScenarioOpts = {
    exec: 'default',
    gracefulStop: '30s',
    options: { browser: { type: 'chromium', headless: true } },
  };

  let scenarios;
  switch (scenario) {
    case 'baseline':
      scenarios = {
        baseline: {
          executor: 'ramping-vus',
          startVUs: 1,
          stages: [
            { duration: '30s', target: 1 },
            { duration: '2m', target: 1 },
            { duration: '30s', target: 0 },
          ],
          ...commonScenarioOpts,
        },
      };
      break;
    case 'burst':
      scenarios = {
        burst: {
          executor: 'shared-iterations',
          vus: 3,
          iterations: 9,
          // maxDuration removed for compatibility with older k6 versions
          ...commonScenarioOpts,
        },
      };
      break;
    case 'soak':
      scenarios = {
        soak: {
          executor: 'constant-vus',
          vus: 2,
          duration: '15m',
          ...commonScenarioOpts,
        },
      };
      break;
    case 'smoke':
    default:
      scenarios = {
        ui_smoke_test: {
          executor: 'shared-iterations',
          iterations: 1,
          vus: 1,
          // maxDuration removed for compatibility with older k6 versions
          ...commonScenarioOpts,
        },
      };
  }

  const setSeg = String(__ENV.SET_SEGMENT_THRESHOLDS || '').toLowerCase();
  const segEnabled = ['1','true','yes','on'].includes(setSeg);

  return {
    scenarios,
    thresholds: {
      browser_web_vital_fcp: ["p(95)<8000"],
      browser_web_vital_lcp: ["p(95)<12000"],
      checks: ["rate>0.7"],
      ...(segEnabled ? {
        // Optional segment thresholds
        crosstabs_wait_import: ['p(95)<60000'],
        crosstabs_run_analysis_redirect: ['p(95)<30000'],
      } : {}),
    },
  };
})();

// Segment timing metrics (ms)
const M = {
  importWait: new Trend('crosstabs_wait_import'),
  runAndRedirect: new Trend('crosstabs_run_analysis_redirect'),
};

// JS heap usage metrics (bytes)
const G = {
  jsHeapBefore: new Gauge('js_heap_before'),
  jsHeapAfter: new Gauge('js_heap_after'),
  jsHeapDelta: new Gauge('js_heap_delta'),
  domNodesBefore: new Gauge('dom_nodes_before'),
  domNodesAfter: new Gauge('dom_nodes_after'),
  domNodesDelta: new Gauge('dom_nodes_delta'),
};

async function segment(name, trend, fn) {
  const t0 = Date.now();
  console.log(`[SEGMENT] start: ${name}`);
  try {
    return await fn();
  } finally {
    const dt = Date.now() - t0;
    if (trend) { trend.add(dt); }
    console.log(`[SEGMENT] done: ${name} in ${dt}ms`);
  }
}

export default async function () {
  const page = await browser.newPage();

  try {
    console.log('Starting crosstabs analysis test...');

    await segment('Navigate to dashboard', null, async () => {
      await page.goto(`${BASE_URL}/dashboard/data`, {
        waitUntil: 'networkidle',
        timeout: 60000,
      });
      check(page, {
        'page loaded successfully': () => page.url().includes('/dashboard/data'),
      });
      await page.waitForSelector('[data-testid="file-menu-trigger"]', { timeout: 30000 });
    });

    await segment('Open Example Data', null, async () => {
      await page.locator('[data-testid="file-menu-trigger"]').click();
      await page.waitForSelector('[data-testid="file-menu-content"]', { timeout: 15000 });
      await page.waitForSelector('[data-testid="file-menu-example-data"]', { timeout: 15000 });
      await page.locator('[data-testid="file-menu-example-data"]').click();
    });

    await segment('Select example dataset', null, async () => {
      console.log('Selecting example dataset...');
      await page.waitForSelector('[data-testid^="example-dataset-"]', { timeout: 60000 });
      let datasetClicked = false;
      try {
        await page.waitForSelector('[data-testid="example-dataset-demo"]', { timeout: 2000 });
        await page.locator('[data-testid="example-dataset-demo"]').click();
        datasetClicked = true;
      } catch (_) {
        try {
          await page.waitForSelector('[data-testid="example-dataset-customer_dbase"]', { timeout: 2000 });
          await page.locator('[data-testid="example-dataset-customer_dbase"]').click();
          datasetClicked = true;
        } catch (__) {
          try {
            await page.waitForSelector('[data-testid="example-dataset-adl"]', { timeout: 2000 });
            await page.locator('[data-testid="example-dataset-adl"]').click();
            datasetClicked = true;
          } catch (___) {
            await page.locator('[data-testid^="example-dataset-"]').first().click();
            datasetClicked = true;
          }
        }
      }
      if (!datasetClicked) {
        throw new Error('Failed to click any example dataset card');
      }
    });

    await segment('Wait for dataset import', M.importWait, async () => {
      try { await page.waitForSelector('[data-testid="loading-spinner"]', { state: 'attached', timeout: 30000 }); } catch (e) { /* spinner may be brief */ }
      try { await page.waitForSelector('[data-testid="loading-spinner"]', { state: 'detached', timeout: 60000 }); } catch (e) { /* bounded wait */ }
      // Ensure example dataset modal is closed if present
      try { await page.waitForSelector('[data-testid="example-dataset-modal"]', { state: 'detached', timeout: 60000 }); } catch (e) { /* may not exist on desktop */ }
      // Ensure Analyze menu is visible
      await page.waitForSelector('[data-testid="analyze-menu-trigger"]', { timeout: 30000 });
    });

    await segment('Open Crosstabs modal', null, async () => {
      console.log('Opening analyze menu...');
      await page.locator('[data-testid="analyze-menu-trigger"]').click();
      await page.waitForSelector('[data-testid="descriptive-statistics-trigger"]', { timeout: 15000 });
      await page.locator('[data-testid="descriptive-statistics-trigger"]').click();
      console.log('Clicking crosstabs analysis...');
      await page.waitForSelector('[data-testid="descriptive-statistics-crosstabs"]', { timeout: 15000 });
      await page.locator('[data-testid="descriptive-statistics-crosstabs"]').click();
      // Wait for either Dialog (mobile) or Sidebar/Tabs (desktop)
      await Promise.race([
        page.waitForSelector('[data-testid="crosstabs-dialog-container"]', { state: 'visible', timeout: 30000 }),
        page.waitForSelector('[data-testid="crosstabs-sidebar-container"]', { state: 'visible', timeout: 30000 }),
        page.waitForSelector('[data-testid="crosstabs-tabs"]', { state: 'visible', timeout: 30000 }),
      ]);
    });

    await segment('Select variables', null, async () => {
      // Ensure Variables tab active
      try { await page.locator('[data-testid="crosstabs-variables-tab"]').click({ timeout: 5000 }); } catch (_) {}

      const availableContainerSel = '[data-testid="available-variables-container"]';
      await page.waitForSelector(availableContainerSel, { timeout: 30000 });
      const availableItemsSel = `${availableContainerSel} [data-testid^="variable-item-available-"]`;
      await page.waitForSelector(availableItemsSel, { timeout: 60000 });

      // Reset to clean state
      await page.locator('[data-testid="crosstabs-reset-button"]').click();

      // Move helpers
      async function clickMoveTo(target) {
        // target: 'row' | 'column'
        try {
          await page.waitForSelector(`[data-testid="central-move-button-${target}"]`, { timeout: 1000 });
          await page.locator(`[data-testid="central-move-button-${target}"]`).click();
        } catch (_) {
          await page.locator(`[data-testid="arrow-move-button-${target}"]`).click();
        }
      }

      async function moveAvailableTo(target, text) {
        try {
          const available = page.locator(availableContainerSel);
          const nameLocator = available.locator(`text=${text}`).first();
          await nameLocator.waitFor({ timeout: 2000 });
          try { await page.evaluate((sel, t) => { const c = document.querySelector(sel); if (!c) return; const el = Array.from(c.querySelectorAll('*')).find(n => (n.textContent||'').includes(t)); if (el && 'scrollIntoView' in el) el.scrollIntoView({ block: 'center', inline: 'center' }); }, availableContainerSel, text); } catch {}
          await nameLocator.click();
          await clickMoveTo(target);
          return true;
        } catch (_) {
          return false;
        }
      }

      async function moveFirstAvailableTo(target) {
        const first = page.locator(availableItemsSel).first();
        await first.click();
        await clickMoveTo(target);
      }

      // Move [gender] to Rows
      const rowContainerSel = '[data-testid="row-variables-container"]';
      const rowItemSel = `${rowContainerSel} [data-testid^=\"variable-item-row-\"]`;
      const movedGender = await moveAvailableTo('row', '[gender]').catch(() => false);
      if (!movedGender) { await moveFirstAvailableTo('row'); }
      // Verify at least one row item exists
      await page.waitForSelector(rowItemSel, { timeout: 10000 }).catch(() => {});

      // Move [age] to Columns
      const colContainerSel = '[data-testid="column-variables-container"]';
      const colItemSel = `${colContainerSel} [data-testid^=\"variable-item-column-\"]`;
      const movedAge = await moveAvailableTo('column', '[age]').catch(() => false);
      if (!movedAge) { await moveFirstAvailableTo('column'); }
      await page.waitForSelector(colItemSel, { timeout: 10000 }).catch(() => {});
    });

    await segment('Configure cells options', null, async () => {
      // Switch to Cells tab
      try { await page.locator('[data-testid="crosstabs-cells-tab"]').click({ timeout: 5000 }); } catch (_) {}

      async function ensureChecked(selector) {
        await page.waitForSelector(selector, { timeout: 60000 });
        try { await page.evaluate((sel) => { const n = document.querySelector(sel); if (n && 'scrollIntoView' in n) n.scrollIntoView({ block: 'center', inline: 'center' }); }, selector); } catch (_) {}
        const state = await page.locator(selector).getAttribute('data-state');
        if (state !== 'checked') {
          await page.locator(selector).click();
        }
      }

      // Counts
      await ensureChecked('[data-testid="crosstabs-observed-checkbox"]');
      await ensureChecked('[data-testid="crosstabs-expected-checkbox"]');
      // Percentages
      await ensureChecked('[data-testid="crosstabs-row-percentages-checkbox"]');
      await ensureChecked('[data-testid="crosstabs-column-percentages-checkbox"]');
      await ensureChecked('[data-testid="crosstabs-total-percentages-checkbox"]');
      // Residuals
      await ensureChecked('[data-testid="crosstabs-unstandardized-residuals-checkbox"]');
      await ensureChecked('[data-testid="crosstabs-standardized-residuals-checkbox"]');
      await ensureChecked('[data-testid="crosstabs-adjusted-residuals-checkbox"]');
    });

    await segment('Run analysis and verify redirect', M.runAndRedirect, async () => {
      // JS heap and DOM nodes before running analysis
      let heapBefore = null;
      let nodesBefore = null;
      // DOM nodes before
      try {
        nodesBefore = await page.evaluate(() => {
          try { return document.querySelectorAll('*').length; } catch (_) { return null; }
        });
      } catch (_) { /* ignore */ }
      if (nodesBefore !== null) { G.domNodesBefore.add(nodesBefore); }
      try {
        heapBefore = await page.evaluate(() => {
          try { return (performance && performance.memory && performance.memory.usedJSHeapSize) || null; } catch (_) { return null; }
        });
      } catch (_) { /* ignore */ }
      if (heapBefore !== null) { G.jsHeapBefore.add(heapBefore); }

      await page.locator('[data-testid="crosstabs-ok-button"]').click();
      // Wait for the modal to close: dialog (mobile) or sidebar/tabs (desktop)
      try {
        await page.waitForSelector('[data-testid="crosstabs-dialog-container"]', { state: 'detached', timeout: 60000 });
      } catch (e) {
        await Promise.race([
          page.waitForSelector('[data-testid="crosstabs-tabs"]', { state: 'detached', timeout: 60000 }).catch(() => {}),
          page.waitForSelector('[data-testid="crosstabs-sidebar-container"]', { state: 'detached', timeout: 60000 }).catch(() => {}),
        ]);
      }

      // Verify redirect to result page (bounded retries)
      let onResult = page.url().includes('/dashboard/result');
      for (let i = 0; i < 10 && !onResult; i++) { sleep(1); onResult = page.url().includes('/dashboard/result'); }
      check(page, {
        'crosstabs analysis navigated to result': () => onResult,
      });

      // Small idle to let UI settle and GC run
      sleep(0.5);

      // DOM nodes after redirect
      try {
        const nodesAfter = await page.evaluate(() => {
          try { return document.querySelectorAll('*').length; } catch (_) { return null; }
        });
        if (nodesAfter !== null) {
          G.domNodesAfter.add(nodesAfter);
          if (nodesBefore !== null) { G.domNodesDelta.add(nodesAfter - nodesBefore); }
        }
      } catch (_) { /* ignore */ }

      // JS heap after redirect
      try {
        const heapAfter = await page.evaluate(() => {
          try { return (performance && performance.memory && performance.memory.usedJSHeapSize) || null; } catch (_) { return null; }
        });
        if (heapAfter !== null) {
          G.jsHeapAfter.add(heapAfter);
          if (heapBefore !== null) { G.jsHeapDelta.add(heapAfter - heapBefore); }
        }
      } catch (_) { /* ignore */ }
    });

    check(page, { 'workflow completed': () => true });

  } catch (error) {
    const errMsg = (error && (error.stack || error.message)) ? (error.stack || error.message) : String(error);
    console.error('Browser test failed:', errMsg);
    check(page, {
      'browser test completed without errors': () => false,
    });
  } finally {
    await page.close();
  }
}
