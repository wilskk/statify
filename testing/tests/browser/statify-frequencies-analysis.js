// Generated by Grafana k6 Studio (1.6.0) on 2025-08-14T11:14:15.158Z
// Modified for Statify testing with smoke test configuration

import { browser } from "k6/browser";
import { check, sleep } from "k6";

const BASE_URL = __ENV.BASE_URL || 'https://statify-dev.student.stis.ac.id';

export const options = {
  scenarios: {
    ui_smoke_test: {
      executor: "shared-iterations",
      iterations: 1,
      vus: 1,
      maxDuration: '10m', // Increased from 5m to 10m for slow import
      options: { 
        browser: { 
          type: "chromium"
        } 
      },
    },
  },
  thresholds: {
    browser_web_vital_fcp: ["p(95)<8000"], // Relaxed threshold
    browser_web_vital_lcp: ["p(95)<12000"], // Relaxed threshold
    checks: ["rate>0.7"], // Lowered expectation due to potential timeouts
  },
};

export default async function () {
  const page = await browser.newPage();

  try {
    console.log('Starting frequencies analysis test...');
    
    // Navigate to Statify
    console.log('Navigating to Statify dashboard...');
    await page.goto(`${BASE_URL}/dashboard/data`, { 
      waitUntil: 'networkidle', 
      timeout: 60000 
    });
    
    // Check if page loaded
    check(page, {
      'page loaded successfully': () => page.url().includes('/dashboard/data'),
    });
    console.log('Page loaded successfully');
    
    // Wait for page to load with increased timeout
    await page.waitForSelector('[data-testid="file-menu-trigger"]', { timeout: 30000 });

    // Basic navigation test - open File menu and Example Data
    await page.locator('[data-testid="file-menu-trigger"]').click();
    await page.waitForSelector('[data-testid="file-menu-content"]', { timeout: 15000 });
    await page.waitForSelector('[data-testid="file-menu-example-data"]', { timeout: 15000 });
    await page.locator('[data-testid="file-menu-example-data"]').click();

    // Select example dataset using stable test ids (prefer customer_dbase, fallback to adl or first)
    console.log('Selecting example dataset...');
    await page.waitForSelector('[data-testid^="example-dataset-"]', { timeout: 60000 });
    let datasetClicked = false;
    try {
      await page.waitForSelector('[data-testid="example-dataset-customer_dbase"]', { timeout: 2000 });
      await page.locator('[data-testid="example-dataset-customer_dbase"]').click();
      datasetClicked = true;
    } catch (_) {
      try {
        await page.waitForSelector('[data-testid="example-dataset-adl"]', { timeout: 2000 });
        await page.locator('[data-testid="example-dataset-adl"]').click();
        datasetClicked = true;
      } catch (__) {
        await page.locator('[data-testid^="example-dataset-"]').first().click();
        datasetClicked = true;
      }
    }
    if (!datasetClicked) {
      throw new Error('Failed to click any example dataset card');
    }
    // Wait for import to complete: spinner disappears and modal closes
    try { await page.waitForSelector('[data-testid="loading-spinner"]', { state: 'attached', timeout: 30000 }); } catch (e) { /* spinner may be brief */ }
    try { await page.waitForSelector('[data-testid="loading-spinner"]', { state: 'detached', timeout: 60000 }); } catch (e) { /* bounded wait */ }
    // Ensure example dataset modal is closed if present
    try { await page.waitForSelector('[data-testid="example-dataset-modal"]', { state: 'detached', timeout: 60000 }); } catch (e) { /* may not exist on desktop */ }
    // Ensure Analyze menu is visible
    await page.waitForSelector('[data-testid="analyze-menu-trigger"]', { timeout: 30000 });

    // Open analyze menu -> Descriptive Statistics -> Frequencies
    console.log('Opening analyze menu...');
    await page.locator('[data-testid="analyze-menu-trigger"]').click();
    await page.waitForSelector('[data-testid="descriptive-statistics-trigger"]', { timeout: 15000 });
    await page.locator('[data-testid="descriptive-statistics-trigger"]').click();

    console.log('Clicking frequencies analysis...');
    await page.waitForSelector('[data-testid="descriptive-statistics-frequencies"]', { timeout: 15000 });
    await page.locator('[data-testid="descriptive-statistics-frequencies"]').click();
    // Frequencies renders as a dialog on mobile and as a sidebar on desktop.
    // Wait for the dialog first; if not present (desktop), wait for the tabs inside the sidebar.
    try {
      await page.waitForSelector('[data-testid="frequencies-dialog"]', { timeout: 12000 });
    } catch (e) {
      await page.waitForSelector('[data-testid="frequencies-tabs"]', { timeout: 30000 });
    }

    // Switch to Variables tab if not already active
    try {
      await page.waitForSelector('[data-testid="available-variables-container"]', { timeout: 5000 });
    } catch (_) {
      try { await page.locator('[data-testid="frequencies-tabs"] [role="tab"]').nth(1).click(); } catch (__) {}
    }
    await page.waitForSelector('[data-testid="available-variables-container"]', { timeout: 30000 });
    // Ensure clean state
    await page.locator('[data-testid="frequencies-reset-button"]').click();

    // Select first available variable and move it to "Variable(s)" via double-click
    await page.waitForSelector('[data-testid="available-variables-container"] [data-testid^="variable-item-available-"]', { timeout: 30000 });
    const firstVar = page.locator('[data-testid="available-variables-container"] [data-testid^="variable-item-available-"]').first();
    await firstVar.dblclick();
    // Ensure it appears in the selected list
    await page.waitForSelector('[data-testid="selected-variables-container"] [data-testid^="variable-item-selected-"]', { timeout: 20000 });

    // Confirm OK is clickable and run the analysis
    await page.locator('[data-testid="frequencies-ok-button"]').click();
    // Optionally wait for the modal to close: dialog (mobile) or sidebar content (desktop)
    try {
      await page.waitForSelector('[data-testid="frequencies-dialog"]', { state: 'detached', timeout: 60000 });
    } catch (e) {
      await page.waitForSelector('[data-testid="frequencies-tabs"]', { state: 'detached', timeout: 60000 }).catch(() => {});
    }

    // Add final check
    // Give a short grace period to observe redirect
    let onResult = page.url().includes('/dashboard/result');
    for (let i = 0; i < 10 && !onResult; i++) { sleep(1); onResult = page.url().includes('/dashboard/result'); }
    check(page, {
      'frequencies analysis navigated to result': () => onResult,
      'workflow completed': () => true,
    });

  } catch (error) {
    const errMsg = (error && (error.stack || error.message)) ? (error.stack || error.message) : String(error);
    console.error('Browser test failed:', errMsg);
    check(page, {
      'browser test completed without errors': () => false,
    });
  } finally {
    await page.close();
  }
}
