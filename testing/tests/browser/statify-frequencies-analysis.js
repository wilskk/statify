// Generated by Grafana k6 Studio (1.6.0) on 2025-08-14T11:14:15.158Z
// Modified for Statify testing with smoke test configuration

import { browser } from "k6/browser";
import { check, sleep } from "k6";
import { Trend, Gauge } from "k6/metrics";

const BASE_URL = __ENV.BASE_URL || 'https://statify-dev.student.stis.ac.id';

// Suppress non-error logs (hide info/warn/segment logs)
try {
  if (typeof console === 'object') {
    console.info = () => {};
    console.warn = () => {};
    console.log = () => {};
  }
} catch (_) {}

export const options = (() => {
  const scenario = (__ENV.SCENARIO || 'smoke').toLowerCase();
  const commonScenarioOpts = {
    exec: 'default',
    gracefulStop: '30s',
    options: { browser: { type: 'chromium', headless: true } },
  };

  let scenarios;
  switch (scenario) {
    case 'baseline':
      // Gentle baseline with small concurrency
      scenarios = {
        baseline: {
          executor: 'ramping-vus',
          startVUs: 1,
          stages: [
            { duration: '30s', target: 1 },
            { duration: '2m', target: 1 },
            { duration: '30s', target: 0 },
          ],
          ...commonScenarioOpts,
        },
      };
      break;
    case 'burst':
      // Short burst of iterations with up to 3 concurrent browsers
      scenarios = {
        burst: {
          executor: 'shared-iterations',
          vus: 3,
          iterations: 9, // ~3 iterations/VU on average
          // maxDuration removed for compatibility with older k6 versions
          ...commonScenarioOpts,
        },
      };
      break;
    case 'soak':
      // Low, steady load for longer period
      scenarios = {
        soak: {
          executor: 'constant-vus',
          vus: 2,
          duration: '15m',
          ...commonScenarioOpts,
        },
      };
      break;
    case 'smoke':
    default:
      // Single iteration sanity check
      scenarios = {
        ui_smoke_test: {
          executor: 'shared-iterations',
          iterations: 1,
          vus: 1,
          // maxDuration removed for compatibility with older k6 versions
          ...commonScenarioOpts,
        },
      };
  }

  const setSeg = String(__ENV.SET_SEGMENT_THRESHOLDS || '').toLowerCase();
  const segEnabled = ['1','true','yes','on'].includes(setSeg);

  return {
    scenarios,
    thresholds: {
      browser_web_vital_fcp: ["p(95)<8000"], // Relaxed threshold
      browser_web_vital_lcp: ["p(95)<12000"], // Relaxed threshold
      checks: ["rate>0.7"], // Lowered expectation due to potential timeouts
      ...(segEnabled ? {
        // Optional segment thresholds (enable with -e SET_SEGMENT_THRESHOLDS=1)
        freq_wait_import: ['p(95)<60000'],
        freq_run_analysis_redirect: ['p(95)<30000'],
      } : {}),
    },
  };
})();

// Segment timing metrics (ms) â€” only measure what matters per user request
const M = {
  importWait: new Trend('freq_wait_import'),
  runAndRedirect: new Trend('freq_run_analysis_redirect'),
};

// JS heap usage metrics (bytes)
const G = {
  jsHeapBefore: new Gauge('js_heap_before'),
  jsHeapAfter: new Gauge('js_heap_after'),
  jsHeapDelta: new Gauge('js_heap_delta'),
  domNodesBefore: new Gauge('dom_nodes_before'),
  domNodesAfter: new Gauge('dom_nodes_after'),
  domNodesDelta: new Gauge('dom_nodes_delta'),
};

async function segment(name, trend, fn) {
  const t0 = Date.now();
  console.log(`[SEGMENT] start: ${name}`);
  try {
    return await fn();
  } finally {
    const dt = Date.now() - t0;
    if (trend) { trend.add(dt); }
    console.log(`[SEGMENT] done: ${name} in ${dt}ms`);
  }
}

export default async function () {
  const page = await browser.newPage();

  try {
    // mark overall start
    var __freqTestStart = Date.now();
    console.log('Starting frequencies analysis test...');

    await segment('Navigate to dashboard', null, async () => {
      await page.goto(`${BASE_URL}/dashboard/data`, {
        waitUntil: 'networkidle',
        timeout: 60000,
      });
      check(page, {
        'page loaded successfully': () => page.url().includes('/dashboard/data'),
      });
      await page.waitForSelector('[data-testid="file-menu-trigger"]', { timeout: 30000 });
    });

    await segment('Open Example Data', null, async () => {
      await page.locator('[data-testid="file-menu-trigger"]').click();
      await page.waitForSelector('[data-testid="file-menu-content"]', { timeout: 15000 });
      await page.waitForSelector('[data-testid="file-menu-example-data"]', { timeout: 15000 });
      await page.locator('[data-testid="file-menu-example-data"]').click();
    });

    await segment('Select example dataset', null, async () => {
      console.log('Selecting example dataset...');
      await page.waitForSelector('[data-testid^="example-dataset-"]', { timeout: 60000 });
      let datasetClicked = false;
      try {
        await page.waitForSelector('[data-testid="example-dataset-demo"]', { timeout: 2000 });
        await page.locator('[data-testid="example-dataset-demo"]').click();
        datasetClicked = true;
      } catch (_) {
        try {
          await page.waitForSelector('[data-testid="example-dataset-customer_dbase"]', { timeout: 2000 });
          await page.locator('[data-testid="example-dataset-customer_dbase"]').click();
          datasetClicked = true;
        } catch (__) {
          try {
            await page.waitForSelector('[data-testid="example-dataset-adl"]', { timeout: 2000 });
            await page.locator('[data-testid="example-dataset-adl"]').click();
            datasetClicked = true;
          } catch (___) {
            await page.locator('[data-testid^="example-dataset-"]').first().click();
            datasetClicked = true;
          }
        }
      }
      if (!datasetClicked) {
        throw new Error('Failed to click any example dataset card');
      }
    });

    await segment('Wait for dataset import', M.importWait, async () => {
      try { await page.waitForSelector('[data-testid="loading-spinner"]', { state: 'attached', timeout: 30000 }); } catch (e) { /* spinner may be brief */ }
      try { await page.waitForSelector('[data-testid="loading-spinner"]', { state: 'detached', timeout: 60000 }); } catch (e) { /* bounded wait */ }
      // Ensure example dataset modal is closed if present
      try { await page.waitForSelector('[data-testid="example-dataset-modal"]', { state: 'detached', timeout: 60000 }); } catch (e) { /* may not exist on desktop */ }
      // Ensure Analyze menu is visible
      await page.waitForSelector('[data-testid="analyze-menu-trigger"]', { timeout: 30000 });
    });

    await segment('Open Frequencies modal', null, async () => {
      console.log('Opening analyze menu...');
      await page.locator('[data-testid="analyze-menu-trigger"]').click();
      await page.waitForSelector('[data-testid="descriptive-statistics-trigger"]', { timeout: 15000 });
      await page.locator('[data-testid="descriptive-statistics-trigger"]').click();
      console.log('Clicking frequencies analysis...');
      await page.waitForSelector('[data-testid="descriptive-statistics-frequencies"]', { timeout: 15000 });
      await page.locator('[data-testid="descriptive-statistics-frequencies"]').click();
      // Wait for either Dialog (mobile) or Tabs (desktop) to become visible (race, like Playwright)
      await Promise.race([
        page.waitForSelector('[data-testid="frequencies-dialog"]', { state: 'visible', timeout: 30000 }),
        page.waitForSelector('[data-testid="frequencies-tabs"]', { state: 'visible', timeout: 30000 }),
      ]);
    });

    await segment('Select variables', null, async () => {
      // Switch to Variables tab if not already active
      try {
        await page.waitForSelector('[data-testid="available-variables-container"]', { timeout: 5000 });
      } catch (_) {
        try { await page.locator('[data-testid="frequencies-tabs"] [role="tab"]').nth(1).click(); } catch (__) {}
      }
      await page.waitForSelector('[data-testid="available-variables-container"]', { timeout: 30000 });
      // Ensure clean state
      await page.locator('[data-testid="frequencies-reset-button"]').click();

      // Helper: choose appropriate move button (mobile vs desktop)
      async function clickMoveToSelected() {
        try {
          await page.waitForSelector('[data-testid="central-move-button-selected"]', { timeout: 1000 });
          await page.locator('[data-testid="central-move-button-selected"]').click();
        } catch (_) {
          await page.locator('[data-testid="arrow-move-button-selected"]').click();
        }
      }

      // Helper: move a variable from Available to Selected via single-click + move button
      async function moveVariableByText(text) {
        try {
          const available = page.locator('[data-testid="available-variables-container"]');
          const nameLocator = available.locator(`text=${text}`).first();
          await nameLocator.waitFor({ timeout: 2000 });
          await nameLocator.click();
          await clickMoveToSelected();
          // Verify it appears in the Selected list
          const selected = page.locator('[data-testid="selected-variables-container"]');
          await selected.locator(`text=${text}`).first().waitFor({ timeout: 10000 });
          return true;
        } catch (_) {
          return false;
        }
      }

      // Fallback: select the first available item by position
      async function moveFirstAvailable() {
        await page.waitForSelector('[data-testid="available-variables-container"] [data-testid^="variable-item-available-"]', { timeout: 30000 });
        const first = page.locator('[data-testid="available-variables-container"] [data-testid^="variable-item-available-"]').first();
        await first.click();
        await clickMoveToSelected();
      }

      // Select variables: try [gender], then [age]; fallback to first two available
      const movedGender = await moveVariableByText('[gender]').catch(() => false);
      if (!movedGender) { await moveFirstAvailable(); }
      const movedAge = await moveVariableByText('[age]').catch(() => false);
      if (!movedAge) { await moveFirstAvailable(); }
    });

    await segment('Configure statistics', null, async () => {
      // Switch to Statistics tab (robust, like Playwright's getByRole name=Statistics)
      async function clickStatisticsTab() {
        const tabsSelector = '[data-testid="frequencies-tabs"] [role="tab"]';
        // Find index of the tab whose text matches Statistics/Statistik
        const idx = await page.evaluate((sel) => {
          const tabs = Array.from(document.querySelectorAll(sel));
          for (let i = 0; i < tabs.length; i++) {
            const txt = (tabs[i].textContent || '').trim();
            if (/statistics|statistik/i.test(txt)) return i;
          }
          return -1;
        }, tabsSelector);

        if (idx >= 0) {
          await page.locator(tabsSelector).nth(idx).click();
          // Verify it becomes selected via aria-selected
          for (let i = 0; i < 20; i++) {
            const selected = await page.evaluate((sel, index) => {
              const els = document.querySelectorAll(sel);
              const el = els[index];
              return !!el && el.getAttribute('aria-selected') === 'true';
            }, tabsSelector, idx);
            if (selected) break;
            await new Promise(r => setTimeout(r, 200));
          }
        } else {
          // Fallback to the 3rd tab (index 2)
          try { await page.locator(tabsSelector).nth(2).click(); } catch (_) { /* ignore */ }
        }
      }

      await clickStatisticsTab();

      // Verify statistics content is active: wait for either quartiles or any stats checkbox
      try {
        await Promise.race([
          page.waitForSelector('#quartiles', { timeout: 60000 }),
          page.waitForSelector('[data-testid="frequencies-mean"]', { timeout: 60000 }),
        ]);
      } catch (_) { /* proceed; ensureChecked will still wait per control */ }

      // Ensure all checkboxes in Statistics tab are checked
      async function ensureChecked(selector) {
        await page.waitForSelector(selector, { timeout: 60000 });
        // Scroll into view before interacting
        try { await page.evaluate((sel) => { const n = document.querySelector(sel); if (n && 'scrollIntoView' in n) n.scrollIntoView({ block: 'center', inline: 'center' }); }, selector); } catch (_) {}
        const state = await page.locator(selector).getAttribute('data-state');
        if (state !== 'checked') {
          await page.locator(selector).click();
        }
      }

      // Percentile Values section checkboxes (by id)
      await ensureChecked('#quartiles');
      await ensureChecked('#cutPoints');
      await ensureChecked('#percentiles');

      // Statistics checkboxes (by data-testid)
      const statTestIds = [
        'frequencies-mean', 'frequencies-median', 'frequencies-mode', 'frequencies-sum',
        'frequencies-stddev', 'frequencies-variance', 'frequencies-range', 'frequencies-minimum', 'frequencies-maximum', 'frequencies-semean',
        'frequencies-skewness', 'frequencies-kurtosis',
      ];
      for (const tid of statTestIds) {
        await ensureChecked(`[data-testid="${tid}"]`);
      }
    });

    await segment('Run analysis and verify redirect', M.runAndRedirect, async () => {
      // JS heap and DOM nodes before running analysis
      let heapBefore = null;
      let nodesBefore = null;
      // DOM nodes before
      try {
        nodesBefore = await page.evaluate(() => {
          try { return document.querySelectorAll('*').length; } catch (_) { return null; }
        });
      } catch (_) { /* ignore */ }
      if (nodesBefore !== null) { G.domNodesBefore.add(nodesBefore); }
      try {
        heapBefore = await page.evaluate(() => {
          try { return (performance && performance.memory && performance.memory.usedJSHeapSize) || null; } catch (_) { return null; }
        });
      } catch (_) { /* ignore */ }
      if (heapBefore !== null) { G.jsHeapBefore.add(heapBefore); }

      await page.locator('[data-testid="frequencies-ok-button"]').click();
      // Wait for the modal to close: dialog (mobile) or sidebar content (desktop)
      try {
        await page.waitForSelector('[data-testid="frequencies-dialog"]', { state: 'detached', timeout: 60000 });
      } catch (e) {
        await page.waitForSelector('[data-testid="frequencies-tabs"]', { state: 'detached', timeout: 60000 }).catch(() => {});
      }
      // Verify redirect to result page (bounded retries)
      let onResult = page.url().includes('/dashboard/result');
      for (let i = 0; i < 10 && !onResult; i++) { sleep(1); onResult = page.url().includes('/dashboard/result'); }
      check(page, {
        'frequencies analysis navigated to result': () => onResult,
      });

      // Small idle to let UI settle and GC run
      sleep(0.5);

      // DOM nodes after redirect
      try {
        const nodesAfter = await page.evaluate(() => {
          try { return document.querySelectorAll('*').length; } catch (_) { return null; }
        });
        if (nodesAfter !== null) {
          G.domNodesAfter.add(nodesAfter);
          if (nodesBefore !== null) { G.domNodesDelta.add(nodesAfter - nodesBefore); }
        }
      } catch (_) { /* ignore */ }

      // JS heap after redirect (or after modal close if redirect took time)
      try {
        const heapAfter = await page.evaluate(() => {
          try { return (performance && performance.memory && performance.memory.usedJSHeapSize) || null; } catch (_) { return null; }
        });
        if (heapAfter !== null) {
          G.jsHeapAfter.add(heapAfter);
          if (heapBefore !== null) { G.jsHeapDelta.add(heapAfter - heapBefore); }
        }
      } catch (_) { /* ignore */ }
    });
    // Mark workflow completed for visibility
    check(page, { 'workflow completed': () => true });

  } catch (error) {
    const errMsg = (error && (error.stack || error.message)) ? (error.stack || error.message) : String(error);
    console.error('Browser test failed:', errMsg);
    check(page, {
      'browser test completed without errors': () => false,
    });
  } finally {
    await page.close();
  }
}
